# Centralized launcher for pull-request related workflows
name: Launch PR Workflows

on:
  pull_request_target:

jobs:
  file-changes-check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    outputs:
      forbidden-files: ${{ steps.changed-files.outputs.ci_any_changed }}
    steps:
      - name: Checkout tfhe-rs
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: 'false'
          token: ${{ secrets.REPO_CHECKOUT_TOKEN }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Check for file changes
        id: changed-files
        uses: tj-actions/changed-files@d6e91a2266cdb9d62096cebf1e8546899c6aa18f
        with:
          since_last_remote_commit: true
          files_yaml: |
            ci:
              - .github/**
              - ci/**
              - scripts/**
              - Makefile

  check-pr-author-permission:
    uses: ./.github/workflows/check_triggering_actor.yml
    with:
      actor: ${{ github.event.pull_request.user.login }}
    secrets:
      TOKEN: ${{ secrets.GITHUB_TOKEN }}

  can-launch-workflows:
    runs-on: ubuntu-latest
    needs: [file-changes-check, check-pr-author-permission]
    if: ${{ always() }}
    steps:
      - name: Does not touch forbidden files
        if: needs.file-changes-check.outputs.forbidden-files == 'false'
        run: |
          echo "Workflows can be launched forbidden files are unchanged"

      - name: Forbidden files have changed
        if: needs.file-changes-check.outputs.forbidden-files == 'true'
        run: |
          if [ "${{ needs.check-pr-author-permission.result }}" == "failure" ]; then
            echo "Actor '${{ github.event.pull_request.user.login }}' is not authorized to perform changes on forbidden files"
            exit 1
          fi

  aws-fast-tests:
    uses: ./.github/workflows/aws_tfhe_fast_tests.yml
    with:
      ref: ${{ github.event.pull_request.head.sha }}
    secrets: inherit
