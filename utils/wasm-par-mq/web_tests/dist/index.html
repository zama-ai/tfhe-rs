<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>wasm-par-mq Web Tests</title>
    <link rel="icon" href="data:,">
</head>
<body>
    <h1>wasm-par-mq Web Tests</h1>
    <input type="checkbox" id="testSuccess" disabled />
    <input type="text" id="benchmarkResults" disabled />

    <input type="button" id="doubleAllAsyncTest" value="doubleAllAsyncTest" disabled />
    <input type="button" id="doubleThenSquareAsyncTest" value="doubleThenSquareAsyncTest" disabled />
    <input type="button" id="doubleAllSyncTest" value="doubleAllSyncTest" disabled max="120" />

    <script type="module">
        import init, * as wasm from './pkg/wasm-par-mq_web_tests.js';

        const WASM_URL = './pkg/wasm-par-mq_web_tests_bg.wasm';
        const BINDGEN_URL = './pkg/wasm-par-mq_web_tests.js';
        const NUM_WORKERS = 4;

        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(`Assertion failed: ${message}`);
            }
        }

        async function initWasmAsync() {
            await init(WASM_URL);
            await wasm.init_async(NUM_WORKERS, WASM_URL, BINDGEN_URL);
        }

        async function initWasmSync() {
            await init(WASM_URL);
            await wasm.init_sync(NUM_WORKERS, WASM_URL, BINDGEN_URL, '/sw.js');
        }

        // --- Test implementations ---

        async function doubleAllAsyncTest() {
            await initWasmAsync();

            const input = Array.from({ length: 100 }, (_, i) => i + 1);
            const result = await wasm.double_all(input);
            const expected = input.map(x => x * 2);
            assert(arraysEqual(result, expected),
                `double_all: expected [${expected.slice(0, 5)}...] got [${result.slice(0, 5)}...]`);
            console.log('PASS: doubleAllAsyncTest');
        }

        async function doubleThenSquareAsyncTest() {
            await initWasmAsync();

            const input = [1, 2, 3, 4, 5];
            const result = await wasm.double_then_square(input);
            const expected = [4, 16, 36, 64, 100]; // (x*2)^2
            assert(arraysEqual(result, expected),
                `double_then_square: expected [${expected}] got [${result}]`);
            console.log('PASS: doubleThenSquareAsyncTest');
        }

        async function doubleAllSyncTest() {
            await initWasmSync();

            const input = Array.from({ length: 100 }, (_, i) => i + 1);
            const result = await wasm.double_all_sync(input);
            const expected = input.map(x => x * 2);
            assert(arraysEqual(result, expected),
                `double_all_sync: expected [${expected.slice(0, 5)}...] got [${result.slice(0, 5)}...]`);
            console.log('PASS: doubleAllSyncTest');
        }

        // --- Wire up buttons ---

        const tests = {
            doubleAllAsyncTest,
            doubleThenSquareAsyncTest,
            doubleAllSyncTest,
        };

        for (const [id, fn] of Object.entries(tests)) {
            const button = document.getElementById(id);
            button.onclick = async () => {
                document.getElementById('testSuccess').checked = false;
                try {
                    await fn();
                    document.getElementById('testSuccess').checked = true;
                } catch (error) {
                    console.error(`FAIL: ${id}: ${error}`);
                    document.getElementById('testSuccess').checked = false;
                }
            };
            button.disabled = false;
        }
    </script>
</body>
</html>
